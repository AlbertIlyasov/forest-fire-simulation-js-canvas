<html>
<style>
canvas {
	border1: 1px solid blue;
	padding: none;
	margin: none;
}
#canvasWrapper {
	float: left;
	padding-right: 20px;
}

#configPanel input[type=number] {
	width: 50px;
}

#statsPanel input {
	width: 80px;
}

#statsPanel label {
	display: block;
	padding-bottom: 4px;
}
</style>
<body onLoad="forest.generate()">
	<div id="wrapper">
		<div id="canvasWrapper">
			<canvas id="example">Обновите браузер</canvas>
		</div>
		<div id="configPanel">
			<fieldset>
				<legend>Density, %</legend>
				<input type="range" min="0" max="100" step="1" value="50" id="densityRange" onChange="config.set('density', this.value); forest.generate();">
				<input type="number" min="0" max="100" step="1" value="50" id="densityInput" onChange="config.set('density', this.value); forest.generate();">
			</fieldset>

			<fieldset>
				<legend>Humidity, %</legend>
				<input type="range" min="0" max="100" step="1" value="50" id="humidityRange" onChange="config.set('humidity', this.value)">
				<input type="number" min="0" max="100" step="1" value="50" id="humidityInput" onChange="config.set('humidity', this.value)">
			</fieldset>

			<fieldset>
				<legend>Duration Burning, %</legend>
				<input type="range" min="1" max="10" step="1" value="8" id="durationBurningRange" onChange="config.set('durationBurning', this.value)">
				<input type="number" min="1" max="10" step="1" value="8" id="durationBurningInput" onChange="config.set('durationBurning', this.value)">
			</fieldset>
		</div>
		<div id="statsPanel">
			<fieldset>
				<legend>Trees</legend>

				<label><input type="text" readonly id="treesTotal"> - Total</label>
				<label><input type="text" readonly id="treesUnBurnings"> - UnBurnings</label>
				<label><input type="text" readonly id="treesBurnings"> - Burnings</label>
				<label><input type="text" readonly id="treesBurnts"> - Burnts</label>
				
				<input type="button" value="Simulation" onClick="forest.simulation()">
			</fieldset>
		</div>
	</div>
		<script>
			

// var a = ["a", "b", "c"];
// var index;
// for (index = 0; index < a.length; ++index) {
//     console.log(a[index]);
// }

function setElementValue(id, value) {
	document.getElementById(id).value = value;
}			

config = {
	inputSuffixs: ['Range', 'Input'],

	set: function(field, value) {
		var value = parseInt(value);
		var i;
		for (i = 0; i < this.inputSuffixs.length; ++i) {
		    setElementValue(field+this.inputSuffixs[i], value);
		}
		forest[field] = value;
		console.log(forest);
	},

	// setElementValue: function(id, value) {
	// 	document.getElementById(id).value = value;
	// },
}

// 
// function arrayHasOwnIndex(array, key) {
//     return array.hasOwnProperty(key) && /^0$|^[1-9]\d*$/.test(key) && key <= 4294967294;
// }
// for (key in a) {
//     if (arrayHasOwnIndex(a, key)) {
//         console.log(a[key]);
//     }
// }
// 

function isKeyExists(array, key) {
    return array.hasOwnProperty(key) && /^0$|^[1-9]\d*$/.test(key) && key <= 4294967294;
}


forest = {
	humidity: 50,
	density: 50,
	durationBurning: 8,
	speedDrying: 10,
	// firePoint: [2,2],

	dots: {
		size: 20,
		qty: {
			x: 10,
			y: 12,
		}
	},

	// stats: {
	// 	cycles: 0,
	// 	total: 0,
	// 	unBurnings: 0,
	// 	burnings: 0,
	// 	burnts: 0,
	// },

	// statuses: {
	// 	grass: 0,
	// 	unburning: 1,
	// 	burning: 2,
	// 	burnt: 3,
	// },


	trees: {
		total: 170,
		unBurnings: [
			//format: x, y, humidity, points
			[0,0,50,10],
			[0,1,50,10],
			[0,2,50,10],
			[0,3,50,10],
			[0,4,50,10],
			[1,1,50,10],
			[2,2,50,10],
			[3,3,50,10],
			[4,4,50,10],
			[5,5,50,10],
			[6,6,50,10],
			[7,7,50,10],
			[8,8,50,10],
			[9,9,50,10],
			[9,10,50,10],
			[9,11,50,10],
			[9,12,50,10],
		],
		burnings: [
			[0,5,50,10],
			[0,6,50,10],
		],
		burnts: [],
	},

	example: {},
	ctx: {},
	colors: {
		grass: '#ADFF2F',
		tree: '#006400',
		burning: '#FF0000',
		burnts: '#808080',
	},

	setFire: function() {
		if (this.trees.unBurnings.length) {
			var key = this.random(0, this.trees.unBurnings.length);
			var x = this.trees.unBurnings[key][0];
			var y = this.trees.unBurnings[key][1];

			this.treeMove('unBurnings', 'burnings', key);
			this.fillDot(x, y, 'burning');
		}
	},

	//попутаемся установить начальную точку огня. Если пользователь кликнул по дереву, то точка установится, о чём будет сообщено путём возврата true. В других случаях возврат false.
	displayStats: function() {
		setElementValue('treesTotal', this.trees.total);
		setElementValue('treesUnBurnings', this.trees.unBurnings.length);
		setElementValue('treesBurnings', this.trees.burnings.length);
		setElementValue('treesBurnts', this.trees.burnts.length);
	},

	//сброс
	reset: function() {
		// this.stats.cycles = 0;
		// this.stats.total = 0;
		// this.stats.unBurnings = 0;
		// this.stats.burnings = 0;
		// this.stats.burnts = 0;

		this.trees.total = 0;
		this.trees.unBurnings = [];
		this.trees.burnings = [];
		this.trees.burnts = [];
	},

	isTree: function() {
		return Math.floor(Math.random() * 2);
	},

	setTreesTotal: function() {
		this.trees.total = Math.floor(this.density/100*this.dots.qty.x*this.dots.qty.y);
	},

	//генерация леса указанной плотности
	generate: function() {
		console.log('generate');
		this.reset();

		var x, y, dot;
		//сначала сделаем, что у нас 100% плотность деревьев.
		for (x = 0; x < this.dots.qty.x; x++) {
			for (y = 0; y < this.dots.qty.y; y++) {
				this.trees.unBurnings.push([x,y,this.humidity,this.durationBurning]);
				// console.log(this.trees.unBurnings);
				console.log(this.isTree());
			}
		}

		this.setTreesTotal();

		//теперь будем уменьшать плотность до тех пор, пока не достигнем запрашиваемого
		while (this.trees.total < this.trees.unBurnings.length){
			this.treeDelete(this.random(0,this.trees.unBurnings.length));
		}

		this.fillGrass();
		this.fillTrees();
		this.setFire();

		this.displayStats();
	},

	random: function(min, max) {
		return Math.floor(Math.random() * (max - min + 1)) + min;
	},

	delete: function(arr, key){
		arr.splice(key, 1);
		return arr;
	},

	simulation: function() {
		if (!this.trees.burnings.length){
			return;
		}

		var tmp, i, neig, neigs, key, keyParent;


		while (this.trees.burnings.length){
		tmp = this.trees;
		//пока есть горящие деревья, симуляция будет работать.
		while (tree = tmp.burnings.pop()) {
			console.log('tree=',tree);
			x = tree[0];
			y = tree[1];
			neigs = [
				// [x, y],
				[x, y-1],
				[x, y+1],
				[x-1, y],
				[x-1, y-1],
				[x-1, y+1],
				[x+1, y],
				[x+1, y-1],
				[x+1, y+1],
			];

			//проверим 8 наших возможных соседей. Если есть сосед и он ещё не горит, то проверим его влажность. Если влажность <=0, сосед загорится. Иначе его влажность просто уменьшится. 
			for (i=0; i<neigs.length; i++){
				neig = neigs[i];
				key = this.search(tmp.unBurnings, neig[0],neig[1]);

				if (key !== false){
					neigTree = tmp.unBurnings[key];

					//если ещё не высохло, станет суше.
					if (neigTree[2]>0){
						this.trees.unBurnings[key][2] -= this.speedDrying;
					//иначе загорается
					} else {
						this.treeMove('unBurnings', 'burnings', this.search(this.trees.unBurnings, neigTree[0],neigTree[1]));
					}
					tmp.unBurnings = this.delete(tmp.unBurnings, key);
				}
			}

			keyParent = this.search(this.trees.burnings, x,y);
			//если дерево ещё не сгорело, уменьшим его жизнь.
			if (tree[3]>0){
				console.log(this.trees.burnings[keyParent]);
				this.trees.burnings[keyParent][3]--;
			//иначе дерево сгорело.
			} else {
				this.treeMove('burnings', 'burnts', key);
			}
			
			this.fillTrees();
		}
		}
	},

	coordAdd: function(prop, x, y){

	},

	treeMove: function(typeFrom, typeTo, key){
		console.log('treeMove: typeFrom='+typeFrom+'typeTo='+typeTo+'key='+key);
		excluded = this.trees[typeFrom].splice(key, 1);
		this.trees[typeTo].push(excluded[0]);
	},

	treeDelete: function(key){
		this.trees.unBurnings.splice(key, 1);
	},

	search: function(arr, x, y){
		var i, len;
		len = arr.length;
		
		for (i=0; i<len; i++) {
			if (arr[i][0] === x && arr[i][1] === y) {
				return i;
			}
		    // console.log('i='+i);
		}
		return false;
	},

	fillGrass: function(){
		this.ctx.fillStyle = this.colors.grass;
		this.ctx.fillRect(0,0, this.example.width, this.example.height);
	},

	fillTrees: function(){
		this.fillGrass();

		var dots = [
			['unBurnings', this.colors.tree],
			['burnings', this.colors.burning],
			['burnts', this.colors.burnt],
		];
			var i, x1,y1,x2,y2;

		var i,type;
		for (i=0; i<dots.length; i++){
			this.ctx.fillStyle = dots[i][1];
			type = dots[i][0];



			// console.log('fillTrees ', this.trees.unBurnings)
			for (i=0; i<this.trees[type].length; i++){
				x1 = this.trees[type][i][0]*this.dots.size;
				y1 = this.trees[type][i][1]*this.dots.size;

				x2 = this.dots.size;
				y2 = this.dots.size;

				this.ctx.fillRect(x1,y1, x2,y2);
			}

		}
	},

	initCanvas: function(id){
		this.example = document.getElementById(id),
	    this.ctx = this.example.getContext('2d');

		this.example.width = this.dots.qty.x*this.dots.size;
		this.example.height = this.dots.qty.y*this.dots.size;
	},

	// dotBurning: function(x, y){
	// 	this.ctx.fillStyle = this.colors.burning;
	// 	var x1,y1,x2,y2;
	// 	x1 = x*this.dots.size;
	// 	y1 = y*this.dots.size;

	// 	x2 = this.dots.size;
	// 	y2 = this.dots.size;
	// 	this.ctx.fillRect(x1,y1, x2,y2);

	// 	console.log(x1,y1, x2,y2);
	// },

	fillDot: function(x, y, colorType){
		this.ctx.fillStyle = this.colors[colorType];
		var x1,y1,x2,y2;
		x1 = x*this.dots.size;
		y1 = y*this.dots.size;

		x2 = this.dots.size;
		y2 = this.dots.size;
		this.ctx.fillRect(x1,y1, x2,y2);

		console.log(x1,y1, x2,y2);
	},
};

forest.initCanvas('example');
forest.fillGrass();

forest.displayStats();
console.log("setFire="+forest.setFire(9,9));

forest.generate();





		</script>
</body>
</html>
